<template><div><h1 id="三-在c-c-应用项目中调用openhitls" tabindex="-1"><a class="header-anchor" href="#三-在c-c-应用项目中调用openhitls"><span>三. 在C/C++应用项目中调用openHiTLS</span></a></h1>
<p>在本章节中将以对称加密和TLS两个示例演示如何在您的项目代码中调用openHiTLS提供的接口。</p>
<h2 id="_1-sm4加密实现示例" tabindex="-1"><a class="header-anchor" href="#_1-sm4加密实现示例"><span>1. SM4加密实现示例</span></a></h2>
<p>创建SM4_CBC.c，代码如下：</p>
<div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_eal_cipher.h"</span> <span class="token comment">// 对称加解密接口头文件</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_sal.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_err.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_algid.h"</span> <span class="token comment">// 算法id列表</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_errno.h"</span> <span class="token comment">// 错误码列表</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">StdMalloc</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_ERR_GetLastErrorFileLine</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取错误发生的文件名和行数</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed at file %s at line %d\n"</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">uint8_t</span> data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0xe3</span><span class="token punctuation">,</span> <span class="token number">0xb0</span><span class="token punctuation">,</span> <span class="token number">0xc4</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0xfc</span><span class="token punctuation">,</span> <span class="token number">0x1c</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0x1c</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint8_t</span> iv<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint8_t</span> key<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> dataLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint8_t</span> cipherText<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint8_t</span> plainText<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> outTotalLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> outLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span> cipherTextLen<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">int32_t</span> ret<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"plain text to be encrypted: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出明文</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dataLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 初始化错误码模块</span></span>
<span class="line">    <span class="token function">BSL_ERR_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// BSL_SAL_CallBack_Ctrl</span></span>
<span class="line">    <span class="token comment">// 如果未注册并且默认能力没有被裁剪,使用默认linux实现</span></span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_MALLOC_CB_FUNC<span class="token punctuation">,</span> StdMalloc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_FREE_CB_FUNC<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 创建上下文</span></span>
<span class="line">    CRYPT_EAL_CipherCtx <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherNewCtx</span><span class="token punctuation">(</span>CRYPT_CIPHER_SM4_CBC<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">BSL_ERR_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 初始化, 最后入参true为加密，false为解密</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherInit</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出错误码，可借助错误码在crypt_errno.h中找到对应的错误信息</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 设置填充模式。</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherSetPadding</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> CRYPT_PADDING_PKCS7<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 输入待计算数据，该接口可以调用多次。此处outLen输入为cipherText长度，输出为处理的数据量</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> data<span class="token punctuation">,</span> dataLen<span class="token punctuation">,</span> cipherText<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outLen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    outTotalLen <span class="token operator">+=</span> outLen<span class="token punctuation">;</span>                     <span class="token comment">// 目前已处理数据量</span></span>
<span class="line">    outLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span> <span class="token operator">-</span> outTotalLen<span class="token punctuation">;</span> <span class="token comment">// cipherText剩余空间</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 填充并处理最后一段数据</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherFinal</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cipherText <span class="token operator">+</span> outTotalLen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outLen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    outTotalLen <span class="token operator">+=</span> outLen<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cipher text value is: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出密文</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outTotalLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> cipherText<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 开始解密流程</span></span>
<span class="line">    cipherTextLen <span class="token operator">=</span> outTotalLen<span class="token punctuation">;</span></span>
<span class="line">    outTotalLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    outLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 初始化, 设置为解密</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherInit</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出错误码，可借助错误码在crypt_errno.h中找到对应的错误信息</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 设置填充模式，填充模式必须和加密的填充模式相同</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherSetPadding</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> CRYPT_PADDING_PKCS7<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 输入密文数据</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cipherText<span class="token punctuation">,</span> cipherTextLen<span class="token punctuation">,</span> plainText<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outLen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    outTotalLen <span class="token operator">+=</span> outLen<span class="token punctuation">;</span>                    <span class="token comment">// 目前已处理数据量</span></span>
<span class="line">    outLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span> <span class="token operator">-</span> outTotalLen<span class="token punctuation">;</span> <span class="token comment">// buffer剩余空间</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 解密最后一段数据并去填充</span></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">CRYPT_EAL_CipherFinal</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> plainText <span class="token operator">+</span> outTotalLen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outLen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> CRYPT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error code is %x\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">PrintLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    outTotalLen <span class="token operator">+=</span> outLen<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"decrypted plain text value is: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出明文</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outTotalLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> plainText<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>outTotalLen <span class="token operator">!=</span> dataLen <span class="token operator">||</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> data<span class="token punctuation">,</span> dataLen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"plaintext comparison failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pass \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">exit<span class="token operator">:</span></span>
<span class="line">    <span class="token comment">// 释放上下文内存</span></span>
<span class="line">    <span class="token function">CRYPT_EAL_CipherFreeCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_ERR_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在同目录下创建Makefile文件，内容如下：</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token assign-left variable">OPEN_PATH</span><span class="token operator">=</span>openhitls</span>
<span class="line"><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>lab-422</span>
<span class="line"><span class="token assign-left variable">BUILD</span><span class="token operator">=</span>build</span>
<span class="line"><span class="token assign-left variable">LINK_FLAGS</span><span class="token operator">=</span>-pthread <span class="token parameter variable">-lhitls_tls</span> <span class="token parameter variable">-lhitls_pki</span> <span class="token parameter variable">-lhitls_crypto</span> <span class="token parameter variable">-lhitls_bsl</span> <span class="token parameter variable">-lboundscheck</span> <span class="token parameter variable">-lsctp</span></span>
<span class="line"><span class="token assign-left variable">LIB</span><span class="token operator">=</span>-L /home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>BUILD<span class="token variable">)</span></span> -Wl,-rpath,/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>BUILD<span class="token variable">)</span></span> -Wl,-rpath,/usr/local/lib/</span>
<span class="line"><span class="token assign-left variable">HEADER</span><span class="token operator">=</span>-I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/crypto -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/bsl -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/tls -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/pki -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/platform/Secure_C/include</span>
<span class="line"></span>
<span class="line">all:sm4</span>
<span class="line"></span>
<span class="line">sm4:</span>
<span class="line">	gcc <span class="token variable"><span class="token variable">$(</span>HEADER<span class="token variable">)</span></span> SM4_CBC.c <span class="token parameter variable">-g</span> <span class="token parameter variable">-o</span> sm4cbc <span class="token variable"><span class="token variable">$(</span>LINK_FLAGS<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LIB<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">clean:</span>
<span class="line">	<span class="token function">rm</span> sm4cbc</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意把USER字段改成自己系统的用户名，确定头文件路径和链接库路径正确。
编译生成可执行文件sm4cbc并运行</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token function">make</span></span>
<span class="line">./sm4cbc</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>示例运行成功</p>
<p><img src="@source/.vuepress/public/sm4cbc运行成功.png" alt=""></p>
<h2 id="_2-tls实现示例" tabindex="-1"><a class="header-anchor" href="#_2-tls实现示例"><span>2. TLS实现示例</span></a></h2>
<p>由于TLS需要同时运行server和client两个程序，而openEuler没有图形化操作界面操作不便，现介绍用PowerShell实现打开多个终端界面。
首先在openEuler系统中查看ip</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token function">ifconfig</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p><img src="@source/.vuepress/public/ifconfig.png" alt=""></p>
<p>可以看到ip地址为192.168.119.131</p>
<p>在windows中打开PowerShell，输入以下命令，然后输入密码</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token function">ssh</span> lab-422@192.168.119.131</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>连接成功</p>
<p><img src="@source/.vuepress/public/ssh连接.png" alt=""></p>
<p>接下来开始实现tls示例。
创建tlss.c和tlsc.c，代码如下，注意修改CERT_PATH的路径：</p>
<div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre><code><span class="line"><span class="token comment">// 基于证书认证的TLS客户端</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_sal.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_err.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_error.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_config.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls.h"</span> </span></span>
<span class="line"><span class="token comment">// #include "hitls_x509.h"</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_cert.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_cert_init.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_crypt_init.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_eal_rand.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_eal_encode.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HTTP_BUF_MAXLEN</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">18</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">/* 18KB */</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CERT_PATH</span> <span class="token string">"/home/lab-422/openhitls/testcode/testdata/tls/certificate/der/rsa_sha256/"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">TCP_Connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span> sockAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span>sockAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    sockAddr<span class="token operator">-></span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></span>
<span class="line">    sockAddr<span class="token operator">-></span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sockAddr<span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"inet_pton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span>sockAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> sockfd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">TCP_Close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token punctuation">{</span> </span>
<span class="line">    <span class="token class-name">int32_t</span> exitValue <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token class-name">int32_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">    HITLS_Config <span class="token operator">*</span>config <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line">    HITLS_Ctx <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line">    BSL_UIO <span class="token operator">*</span>uio <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 注册BSL内存能力、仅供参考 */</span> </span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_MALLOC_CB_FUNC<span class="token punctuation">,</span> malloc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_FREE_CB_FUNC<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_ERR_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">HITLS_CertMethodInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">CRYPT_EAL_RandInit</span><span class="token punctuation">(</span>CRYPT_RAND_SHA256<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">HITLS_CryptMethodInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* TCP链接需用户实现能力 */</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sockAddr<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">TCP_Connect</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sockAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SCTP_Connect failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    config <span class="token operator">=</span> <span class="token function">HITLS_CFG_NewTLSConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_CFG_NewTLS12Config failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token function">HITLS_CFG_SetCheckKeyUsage</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">HITLS_CFG_SetFlightTransmitSwitch</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/* 加载证书：需要用户实现 */</span> </span>
<span class="line">    <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    HITLS_CERT_X509 <span class="token operator">*</span>ca_cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_X509_CertParseFile</span><span class="token punctuation">(</span>TLS_PARSE_FORMAT_PEM<span class="token punctuation">,</span></span>
<span class="line">                                CERT_PATH<span class="token string">"ca.der"</span><span class="token punctuation">,</span></span>
<span class="line">                                <span class="token operator">&amp;</span>ca_cert<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ca parse r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_CFG_AddCertToStore</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> ca_cert<span class="token punctuation">,</span> TLS_CERT_STORE_TYPE_DEFAULT<span class="token punctuation">,</span></span>
<span class="line">                                false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add ca cert r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    HITLS_CERT_X509 <span class="token operator">*</span>inter_cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_X509_CertParseFile</span><span class="token punctuation">(</span>TLS_PARSE_FORMAT_PEM<span class="token punctuation">,</span></span>
<span class="line">                                CERT_PATH<span class="token string">"inter.der"</span><span class="token punctuation">,</span></span>
<span class="line">                                <span class="token operator">&amp;</span>inter_cert<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"inter parse r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_CFG_AddCertToStore</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> inter_cert<span class="token punctuation">,</span> TLS_CERT_STORE_TYPE_DEFAULT<span class="token punctuation">,</span></span>
<span class="line">                                false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add inter cert r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// r=HITLS_CFG_LoadCertFile(config, "/home/ling/ca_server.crt", TLS_CERT_STORE_TYPE_DEFAULT);</span></span>
<span class="line">    <span class="token comment">// printf("add encCert r=0x%x\n", r);</span></span>
<span class="line">    <span class="token comment">/* 新建openHiTLS上下文 */</span> </span>
<span class="line">    ctx <span class="token operator">=</span> <span class="token function">HITLS_New</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_New failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 用户可按需实现method */</span> </span>
<span class="line">    uio <span class="token operator">=</span> <span class="token function">BSL_UIO_New</span><span class="token punctuation">(</span><span class="token function">BSL_UIO_TcpMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>uio <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"BSL_UIO_New failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">BSL_UIO_Ctrl</span><span class="token punctuation">(</span>uio<span class="token punctuation">,</span> BSL_UIO_SET_FD<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">BSL_UIO_Free</span><span class="token punctuation">(</span>uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"BSL_UIO_SET_FD failed, fd = %u.\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_SetUio</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">BSL_UIO_Free</span><span class="token punctuation">(</span>uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_SetUio failed. ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 进行TLS连接、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Connect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Connect failed, ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 向对端发送报文、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> sndBuf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hi, this is client\n"</span><span class="token punctuation">;</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sndBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sndBuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Write error:error code:%d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 读取对端报文、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    <span class="token class-name">uint8_t</span> readBuf<span class="token punctuation">[</span>HTTP_BUF_MAXLEN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token class-name">uint32_t</span> readLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Read</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> readBuf<span class="token punctuation">,</span> HTTP_BUF_MAXLEN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readLen<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Read failed, ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get from server size:%u :%s\n"</span><span class="token punctuation">,</span> readLen<span class="token punctuation">,</span> readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line">    exitValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">exit<span class="token operator">:</span> </span>
<span class="line">    <span class="token function">HITLS_Close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">HITLS_Free</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">HITLS_CFG_FreeConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">TCP_Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">return</span> exitValue<span class="token punctuation">;</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre v-pre><code><span class="line"><span class="token comment">//基于证书认证的TLS服务端</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HITLS_CRYPTO_EAL</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HITLS_CRYPTO_CIPHER</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_sal.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"bsl_err.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_error.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_config.h"</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls.h"</span> </span></span>
<span class="line"><span class="token comment">// #include "hitls_x509.h"</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_cert.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_cert_init.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hitls_crypt_init.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_eal_rand.h"</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"crypt_eal_encode.h"</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HTTP_BUF_MAXLEN</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">18</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">/* 18KB */</span> </span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CERT_PATH</span> <span class="token string">"/home/lab-422/openhitls/testcode/testdata/tls/certificate/der/rsa_sha256/"</span></span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">TCP_Bind</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 创建套接字</span></span>
<span class="line">    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 设置服务器地址信息</span></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></span>
<span class="line">    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span></span>
<span class="line">    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 绑定套接字到指定端口</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 开始监听连接请求</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> sockfd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">TCP_Accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> listenFd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span> clientAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> clientFd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">socklen_t</span> clientAddrLen<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 等待客户端连接请求</span></span>
<span class="line">    clientAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    clientFd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenFd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 将客户端地址信息保存到clientAddr中</span></span>
<span class="line">    <span class="token function">memcpy</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> clientFd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">TCP_Close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token punctuation">{</span> </span>
<span class="line">    <span class="token class-name">int32_t</span> exitValue <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token class-name">int32_t</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">    HITLS_Config <span class="token operator">*</span>config <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line">    HITLS_Ctx <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line">    BSL_UIO <span class="token operator">*</span>uio <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 注册BSL内存能力、仅供参考 */</span> </span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_MALLOC_CB_FUNC<span class="token punctuation">,</span> malloc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_SAL_CallBack_Ctrl</span><span class="token punctuation">(</span>BSL_SAL_MEM_FREE_CB_FUNC<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">BSL_ERR_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">HITLS_CertMethodInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">CRYPT_EAL_RandInit</span><span class="token punctuation">(</span>CRYPT_RAND_SHA256<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">HITLS_CryptMethodInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/* TCP链接需用户实现能力 */</span></span>
<span class="line">    <span class="token keyword">int</span> listenFd <span class="token operator">=</span> <span class="token function">TCP_Bind</span><span class="token punctuation">(</span><span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sockAddr<span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">TCP_Accept</span><span class="token punctuation">(</span>listenFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sockAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TCP_Accept failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    config <span class="token operator">=</span> <span class="token function">HITLS_CFG_NewTLSConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_CFG_NewTLS12Config failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token function">HITLS_CFG_SetCheckKeyUsage</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">HITLS_CFG_SetFlightTransmitSwitch</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/* 加载证书：需要用户实现 */</span> </span>
<span class="line">    <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    HITLS_CERT_X509 <span class="token operator">*</span>ca_cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_X509_CertParseFile</span><span class="token punctuation">(</span>TLS_PARSE_FORMAT_PEM<span class="token punctuation">,</span></span>
<span class="line">                                CERT_PATH<span class="token string">"ca.der"</span><span class="token punctuation">,</span></span>
<span class="line">                                <span class="token comment">// "/home/ling/ca_server.crt"</span></span>
<span class="line">                                <span class="token operator">&amp;</span>ca_cert<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ca parse r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_CFG_AddCertToStore</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> ca_cert<span class="token punctuation">,</span> TLS_CERT_STORE_TYPE_DEFAULT<span class="token punctuation">,</span></span>
<span class="line">                                false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add ca cert r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    HITLS_CERT_X509 <span class="token operator">*</span>inter_cert <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_X509_CertParseFile</span><span class="token punctuation">(</span>TLS_PARSE_FORMAT_PEM<span class="token punctuation">,</span></span>
<span class="line">                                CERT_PATH<span class="token string">"inter.der"</span><span class="token punctuation">,</span></span>
<span class="line">                                <span class="token operator">&amp;</span>inter_cert<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"inter parse r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">HITLS_CFG_AddCertToStore</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> inter_cert<span class="token punctuation">,</span> TLS_CERT_STORE_TYPE_DEFAULT<span class="token punctuation">,</span></span>
<span class="line">                                false<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add inter cert r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 从文件中加载加密证书和私钥    </span></span>
<span class="line">    r<span class="token operator">=</span><span class="token function">HITLS_CFG_LoadCertFile</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> CERT_PATH<span class="token string">"server.der"</span><span class="token punctuation">,</span> TLS_PARSE_FORMAT_ASN1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add encCert r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    r<span class="token operator">=</span><span class="token function">HITLS_CFG_LoadKeyFile</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> CERT_PATH<span class="token string">"server.key.der"</span><span class="token punctuation">,</span> TLS_PARSE_FORMAT_ASN1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add encKey r=0x%x\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">/* 新建openHiTLS上下文 */</span> </span>
<span class="line">    ctx <span class="token operator">=</span> <span class="token function">HITLS_New</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_New failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 用户可按需实现method */</span> </span>
<span class="line">    uio <span class="token operator">=</span> <span class="token function">BSL_UIO_New</span><span class="token punctuation">(</span><span class="token function">BSL_UIO_TcpMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>uio <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"BSL_UIO_New failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">BSL_UIO_Ctrl</span><span class="token punctuation">(</span>uio<span class="token punctuation">,</span> BSL_UIO_SET_FD<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">BSL_UIO_Free</span><span class="token punctuation">(</span>uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"BSL_UIO_SET_FD failed, fd = %u.\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_SetUio</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">BSL_UIO_Free</span><span class="token punctuation">(</span>uio<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_SetUio failed. ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 进行TLS连接、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Accept</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Accept failed, ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 读取对端报文、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    <span class="token class-name">uint8_t</span> readBuf<span class="token punctuation">[</span>HTTP_BUF_MAXLEN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token class-name">uint32_t</span> readLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Read</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> readBuf<span class="token punctuation">,</span> HTTP_BUF_MAXLEN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readLen<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Read failed, ret = 0x%x.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get from client size:%u :%s\n"</span><span class="token punctuation">,</span> readLen<span class="token punctuation">,</span> readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* 向对端发送报文、用户需按实际场景考虑返回值 */</span> </span>
<span class="line">    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> sndBuf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hi, this is server\n"</span><span class="token punctuation">;</span> </span>
<span class="line">    ret <span class="token operator">=</span> <span class="token function">HITLS_Write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sndBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sndBuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> HITLS_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HITLS_Write error:error code:%d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    exitValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line">exit<span class="token operator">:</span> </span>
<span class="line">    <span class="token function">HITLS_Close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">HITLS_Free</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">HITLS_CFG_FreeConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token function">TCP_Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">return</span> exitValue<span class="token punctuation">;</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在同目录下创建Makefile文件，内容如下：</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token assign-left variable">OPEN_PATH</span><span class="token operator">=</span>openhitls</span>
<span class="line"><span class="token assign-left variable">BUILD</span><span class="token operator">=</span>build</span>
<span class="line"><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>lab-422</span>
<span class="line"><span class="token assign-left variable">LINK_FLAGS</span><span class="token operator">=</span>-pthread <span class="token parameter variable">-lhitls_tls</span> <span class="token parameter variable">-lhitls_pki</span> <span class="token parameter variable">-lhitls_crypto</span> <span class="token parameter variable">-lhitls_bsl</span> <span class="token parameter variable">-lboundscheck</span> <span class="token parameter variable">-lsctp</span></span>
<span class="line"><span class="token assign-left variable">LIB</span><span class="token operator">=</span>-L /home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>BUILD<span class="token variable">)</span></span> -Wl,-rpath,/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>BUILD<span class="token variable">)</span></span> -Wl,-rpath,/usr/local/lib/</span>
<span class="line"><span class="token assign-left variable">HEADER</span><span class="token operator">=</span>-I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/crypto -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/bsl -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/tls -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/include/pki -I/home/<span class="token variable"><span class="token variable">$(</span><span class="token environment constant">USER</span><span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>OPEN_PATH<span class="token variable">)</span></span>/platform/Secure_C/include</span>
<span class="line"></span>
<span class="line">all:tls</span>
<span class="line"></span>
<span class="line">tls:</span>
<span class="line">	gcc <span class="token variable"><span class="token variable">$(</span>HEADER<span class="token variable">)</span></span> tlss.c <span class="token parameter variable">-g</span> <span class="token parameter variable">-o</span> tlss <span class="token variable"><span class="token variable">$(</span>LINK_FLAGS<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LIB<span class="token variable">)</span></span></span>
<span class="line">	gcc <span class="token variable"><span class="token variable">$(</span>HEADER<span class="token variable">)</span></span> tlsc.c <span class="token parameter variable">-g</span> <span class="token parameter variable">-o</span> tlsc <span class="token variable"><span class="token variable">$(</span>LINK_FLAGS<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LIB<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">clean:</span>
<span class="line">	<span class="token function">rm</span> tlss tlsc</span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输入make，并运行tls服务端</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line"><span class="token function">make</span></span>
<span class="line">./tlss</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动一个新的PowerShell窗口，ssh连接到openEuler系统，运行tls服务端</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre v-pre><code><span class="line">./tlsc</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>可以看到两个窗口都有输出，示例运行成功</p>
<p><img src="@source/.vuepress/public/tlsc.png" alt=""></p>
<p><img src="@source/.vuepress/public/tlss.png" alt=""></p>
</div></template>


